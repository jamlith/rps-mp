var fb = firebase.database();           // shortcut to the firebase database object
var cxsRef = fb.ref('cxs/');            // a list of the clients that are connected, and a unique id assigned to each
var usrRef = fb.ref('usr/');            // a list of the users that joined the game... username, csx id, score
var msgRef = fb.ref('msgs/');           // a list of the chat messages, and who sent them
var moveRef = fb.ref('moves/');         // the move that each player has chosen for the current round
var conMon = fb.ref('.info/connected'); // this is an internal variable that is true as long as you are connected to the db
// an object with info about the players
var rps = {
    p1id: null,
    p1name: null,
    p1wins: null,
    p1losses: null,
    p1ties: null,
    p2id: null,
    p2name: null,
    p2wins: null,
    p2losses: null,
    p2ties: null
};
var p1_moved = false;
var p2_moved = false;
// varibale for the local client, username,id, slotnum
var uname = null;
var uid = null;
var slotnum = null;

// cxs/ <uid>:true, ...
// usr/ {<slot>, <uid>, <name>, <wins>, <losses>, <ties>}, ...
// msgs/ ukey: {<from>, <msg>}, ...
// moves/ {<slot>: <move>, slot: <move>}

function init() {
    // Set everything to its initial state.
    $('#p1-input').hide();     // hide the join form until you are connected to the db
	$('#p1-controls').hide();  // hide the buttons and scoreboard until player chooses name/slot
	$('#p2-input').hide();     // }
	$('#p2-controls').hide();  // }   same as above
	$('#chat-form').hide();    // hide chat form until properly connected and identified
    $('.p2-buttons').hide();   // }
    $('.p1-buttons').hide();   // } hide buttons until player chooses a slot
    // monitor connection status for changes...
	conMon.on('value', function(ss) {
		if (ss.val()) {
			// ^ true while connected
			var key = cxsRef.push(true); // add connection to the list
			uid = key.key;               // save the key generated by push(), use as unique id
			key.onDisconnect().remove(); // if disconnected, remove the entry
			$('#p1-input').fadeIn();     // }
			$('#p2-input').fadeIn();     // } show the name/join forms
            outputMessage("Connected to the database, id is " + uid + "."); // print a message to the chat informing the user that they are connected
		}
	});    // end conMon procedure
    // check the player slots for existing users
    usrRef.once('value').then(function(ss) {
        // if slot 1 is occupied...
        if (ss.child('slot1').exists()) {
            $('#p1-input').fadeOut();                   // remove the form to join slot 1
            $('#p1-controls').fadeIn();                 // show the scoreboard for player 1
            $('.p1-labels').text(ss.val().slot1.name);  // display user's name in the scoreboard
        }   // if slot 1 is empty...
        else {
            $('#p1-input').fadeIn();    // show the form to join slot 1
        }   // if slot 2 is occupied...
        if (ss.child('slot2').exists()) {
            $('#p2-input').fadeOut();                   // remove the form to join slot 2
            $('#p2-controls').fadeIn();                 // show the scoreboard for player 2
            $('.p2-labels').text(ss.val().slot2.name);  // display user's name to the scoreboard
        }   // if slot 2 is empty...
        else {
            $('#p2-input').fadeIn();    // show the form to join slot 2
        }
    }); // end user change procedure
    // monitor player slots for new entries
	usrRef.on('child_added', function() {
        // pull a snapshot of the user list
        fb.ref().once("value").then(function(ss) {
            // if slot 1 is full...
    		if (ss.child('usr').child('slot1').exists()) {
    			rps.p1id = ss.val().usr.slot1.id;            // assign the user's id to the local object
    			rps.p1name = ss.val().usr.slot1.name;        // ...the user's name
    			rps.p1wins = ss.val().usr.slot1.wins;        // ...the user's wins
    			rps.p1losses = ss.val().usr.slot1.losses;    // ...losses
    			rps.p1ties = ss.val().usr.slot1.ties;        // ...ties
    			$('.p1-labels').text(rps.p1name);    // display user's name om the scoreboard
    			$('#p1-wins').text(rps.p1wins);      // wins
    			$('#p1-losses').text(rps.p1losses);  // losses
    			$('#p1-ties').text(rps.p1ties);      // ties
    			$('#p1-input').fadeOut();   // hide the p1 name/join form
                $('#p1-controls').fadeIn(); // show the p1 scoreboard
    		}
            // if slot 2 is full
    		if (ss.child('usr').child('slot2').exists()) {
    			rps.p2id = ss.val().usr.slot2.id;            // assign the user's id to the local object
    			rps.p2name = ss.val().usr.slot2.name;        // ...the user's name
    			rps.p2wins = ss.val().usr.slot2.wins;        // ...the user's wins
    			rps.p2losses = ss.val().usr.slot2.losses;    // ...losses
    			rps.p2ties = ss.val().usr.slot2.ties;        // ...ties
    			$('.p2-labels').text(rps.p2name);    // display user's name om the scoreboard
    			$('#p2-wins').text(rps.p2wins);      // wins
    			$('#p2-losses').text(rps.p2losses);  // losses
    			$('#p2-ties').text(rps.p2ties);      // ties
    			$('#p2-input').fadeOut();   // show the p2 name/join form
                $('#p2-controls').fadeIn(); // show the p2 scoreboard
    		}
        }); // end user list snapshot
	});  // end user added procedure
    // monitor user removal
	usrRef.on('child_removed', function(ss) {
        // opppnents disconnection resets the game
        outputMessage('A user disconnected.', 'alert');  // alert the user that his opponent disconnected
        // if user was already bound to a slot
        if (slotnum !== null) {
            bindUser(slotnum, uname);   // rebind user to previous slot
        }
        // if slot 1 is empty
		if (!ss.hasChild('slot1')) {
			$('.p1-labels').text('N/A'); // reset username on the scoreboard
			$('#p1-wins').text(0);       // reset wins
			$('#p1-losses').text(0);     // losses
			$('#p1-ties').text(0);       // ties
			$('#p1-controls').fadeOut(); // hide the p1 scoreboard
            // if user is connected but hasn't been bound to a slot
			if (slotnum === null && uid !== null) {
				$('#p1-input').fadeIn();    // show p1 name/join form
			} // if user is already bound to a slot, or if they aren't connected
            else {
				$('#p1-input').fadeOut();   // hide the name/join form
			}
			rps.p1name = null;   // reset the p1 vars in the local object
			rps.p1uid = null;    // ...
			rps.p1wins = null;   // ...
			rps.p1Losses = null; // ...
			rps.p1ties = null;   // ...
		}
        // if slot 2 is empty
		if (!ss.hasChild('slot2')) {
			$('.p2-labels').text('N/A'); // reset username on the scoreboard
			$('#p2-wins').text(0);       // wins
			$('#p2-losses').text(0);     // losses
			$('#p2-ties').text(0);       // ties
			$('#p2-controls').fadeOut(); // hide the p2 scoreboard
            // if user is connected but hasn't been bound to a slot
            if (slotnum === null && uid !== null) {
				$('#p2-input').fadeIn(); // show p2 name/join form
			}  // if user is already bound to a slot, or if they aren't connected
            else {
				$('#p2-input').fadeOut(); // hide name/join form
			}
			rps.p2name = null;   // reset the p2 vars in the local object
			rps.p2uid = null;    // ...
			rps.p2wins = null;   // ...
			rps.p2Losses = null; // ...
			rps.p2ties = null;   // ...
		}
	});  // end usrRef child_removed
    // when a move has been made by one of the players...
    moveRef.on('child_added', function(ss) {
        // pull a snapshot of the user list
        moveRef.once('value').then(function(ss) {
            // if both users have registered a move
            if (ss.child('slot1').exists() && ss.child('slot2').exists()) {
                // if user 1 chose rock
                $('.p1-buttons').removeClass('active');
                $('.p2-buttons').removeClass('active');
                p1_moved = false;
                p2_moved = false;
                if (ss.val().slot1 == 'Rock') {
                    // and user 2 chose rock
                    if (ss.val().slot2 == 'Rock') {
                        // Notify users that it was a tie, update score, remove the moves from the moves list
                        outputMessage('Rock vs Rock... round ended in a tie!  Make your next move...');
                        rps.p1ties++;
                        rps.p2ties++;
                        $('#p1-ties').text(rps.p1ties);
                        $('#p2-ties').text(rps.p2ties);
                        moveRef.remove();
                    }
                    // or user 2 chose paper
                    if (ss.val().slot2 == 'Paper') {
                        // user 1 loses
                        outputMessage('Paper vs Rock... Player 2 wins!  Make your next move...');
                        rps.p1losses++;
                        rps.p2wins++;
                        $('#p1-losses').text(rps.p1losses);
                        $('#p2-wins').text(rps.p2wins);
                        moveRef.remove();
                    }
                    // or user 2 chose scissors
                    if (ss.val().slot2 == 'Scissors') {
                        // user 1 wins
                        outputMessage('Rock vs Scissors... Player 1 wins!  Make your next move...');
                        rps.p2losses++;
                        rps.p1wins++;
                        $('#p2-losses').text(rps.p2losses);
                        $('#p1-wins').text(rps.p1wins);
                        moveRef.remove();
                    }
                }
                // if user 1 chose paper
                if (ss.val().slot1 == 'Paper') {
                    // and user 2 chose paper
                    if (ss.val().slot2 == 'Paper') {
                        // tie
                        outputMessage('Paper vs Paper... round ended in a tie!  Make your next move...');
                        rps.p1ties++;
                        rps.p2ties++;
                        $('#p1-ties').text(rps.p1ties);
                        $('#p2-ties').text(rps.p2ties);
                        moveRef.remove();
                    }
                    // or user 2 chose scissors
                    if (ss.val().slot2 == 'Scissors') {
                        // user 1 loses
                        outputMessage('Scissors vs Paper... Player 2 wins!  Make your next move...');
                        rps.p1losses++;
                        rps.p2wins++;
                        $('#p1-losses').text(rps.p1losses);
                        $('#p2-wins').text(rps.p2wins);
                        moveRef.remove();
                    }
                    // and user 2 chose rock
                    if (ss.val().slot2 == 'Rock') {
                        // user 1 wins
                        outputMessage('Paper vs Rock... Player 1 wins!  Make your next move...');
                        rps.p2losses++;
                        rps.p1wins++;
                        $('#p2-losses').text(rps.p2losses);
                        $('#p1-wins').text(rps.p1wins);
                        moveRef.remove();
                    }
                }
                // if user 1 chose scissors
                if (ss.val().slot1 == 'Scissors') {
                    // and user 2 chose scissors
                    if (ss.val().slot2 == 'Scissors') {
                        // tie
                        outputMessage('Scissors vs Scissors... round ended in a tie!  Make your next move...');
                        rps.p1ties++;
                        rps.p2ties++;
                        $('#p1-ties').text(rps.p1ties);
                        $('#p2-ties').text(rps.p2ties);
                        moveRef.remove();
                    }
                    // and user 2 chose rock
                    if (ss.val().slot2 == 'Rock') {
                        // user 1 loses
                        outputMessage('Rock vs Scissors... Player 2 wins!  Make your next move...');
                        rps.p1losses++;
                        rps.p2wins++;
                        $('#p1-losses').text(rps.p1losses);
                        $('#p2-wins').text(rps.p2wins);
                        moveRef.remove();
                    }
                    // and user 2 chose paper
                    if (ss.val().slot2 == 'Paper') {
                        // user 1 wins
                        outputMessage('Scissors vs Paper... Player 1 wins!  Make your next move...');
                        rps.p2losses++;
                        rps.p1wins++;
                        $('#p2-losses').text(rps.p2losses);
                        $('#p1-wins').text(rps.p1wins);
                        moveRef.remove();
                    }
                }
            }
        }); // end snapshot
    }); // end move monitoring
    // when a new message is added to the message list
    msgRef.on('child_added', function(ss) {
        outputMessage(ss.val().msg, ss.val().from); // print it to the chat window
    }); // end message monitoring

}

function bindUser(slot, name) {
	console.log("bindUser()...");
	usrRef.once('value').then(function(ss) {
		if (ss.child('slot' + slot).exists()) {
			console.log('player slot is occupied... aborting!');
			return false;
		}
		if (name.length < 1) {
			name = "Unnamed" + slot;
		}

		uname = name;
		slotnum = slot;
		if (slot == 1) {
			usrRef.update({ 'slot1': { 'id': uid, 'name': name, 'wins': 0, 'losses': 0, 'ties': 0 } });
            $('#p1-input').fadeOut();
            $('#p2-input').fadeOut();
            $('#chat-form').fadeIn();
            $('#p1-controls').fadeIn();
            $('#p2-controls').fadeIn();
            $('.p1-buttons').fadeIn();
		} else if (slot == 2) {
			usrRef.update({ 'slot2': { 'id': uid, 'name': name, 'wins': 0, 'losses': 0, 'ties': 0 } });
            $('#p1-input').fadeOut();
            $('#p2-input').fadeOut();
            $('#chat-form').fadeIn();
            $('#p1-controls').fadeIn();
            $('#p2-controls').fadeIn();
            $('.p2-buttons').fadeIn();
        }

		usrRef.onDisconnect().remove();
	});
}
function outputMessage(message, header=null, header_classes="text-primary chat-text", classes="text-dark") {
	// prints to the chat box.  the only mandatory argument is the message.  the
    // behavior can be radically different base on the options you send along...
    //
    // outputMessage(<msg>) will display a lightweight system notice, italic
    // ...(<msg>, alert) will highlight the text and add weight to the data
    // ...(<msg>, <username>) will write "<user>: msg", the header in blue
    // ...(<msg>, alert, danger ) will change the alert to red
    // ...(<msg>, <header>)
	var outputObj, headerObj, contentObj, modifiedHdr, modifiedContent;
	var colors = [ 'default', 'primary', 'success', 'info', 'warning', 'danger', 'light', 'dark' ];

	if (header !== null) {
        // if a header was supplied
		if (header == "alert") {
            // make this an alert
			if (colors.indexOf(classes) !== -1) {
				classes = 'alert alert-' + classes;
			} else {
				classes = 'alert alert-info';
			}
            classes += " chat-alert"
			outputObj = $("<span>").addClass(classes + " font-weight-bold").append(message);
			$("#chat").prepend(outputObj);
			return true;
		} else {
            //
			if (colors.indexOf(header_classes) !== -1) {
				header_classes = "text-" + header_classes + " chat-text";
			} else if (header_classes === null || header_classes === '') {
				header_classes = "text-primary chat-text";
			}

			if (colors.indexOf(classes) !== -1) {
				classes = "text-" + classes;
			} else if (header_classes === null || header_classes === '') {
				classes = "";
			}
			contentObj = $('<p>').addClass(classes).append($('<span>').addClass(header_classes).append(header + ": ")).append(message);
			$('#chat').prepend(contentObj);
			return true;
		}
	} else {
		outputObj = $("<span>").addClass('text-info font-italic chat-alert').append(message)
		$('#chat').prepend(outputObj);
	}
} // end init()
// click events
$('#p1-join').click(function(event) {
		console.log('CLICK! p1-join.');
		var name_input = $('#p1-name').val();
		bindUser(1, name_input);

});
$('#p2-join').click(function(event) {
		console.log('CLICK! p2-join.');
		var name_input = $('#p2-name').val();
		bindUser(2, name_input);
});
$('#p1-rock').click(function(event) {
    if (!p1_moved) {
        p1_moved = true;
        $('#p1-rock').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot1').exists()) {
            moveRef.update({'slot1': 'Rock'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot2').exists()) {
                outputMessage('You chose Rock.');
            } else {
                outputMessage("You chose Rock... waiting for opponent's move");
            }
        }
    });
});
$('#p2-rock').click(function(event) {
    if (!p2_moved) {
        p2_moved = true;
        $('#p2-rock').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot2').exists()) {
            moveRef.update({'slot2': 'Rock'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot1').exists()) {
                outputMessage('You chose Rock.');
            } else {
                outputMessage("You chose Rock... waiting for opponent's move");
            }
        }
    });
});
$('#p1-paper').click(function(event) {
    if (!p1_moved) {
        p1_moved = true;
        $('#p1-paper').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot1').exists()) {
            moveRef.update({'slot1': 'Paper'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot2').exists()) {
                outputMessage('You chose Paper.');
            } else {
                outputMessage("You chose Paper... waiting for opponent's move");
            }
        }
    });
});
$('#p2-paper').click(function(event) {
    if (!p2_moved) {
        p2_moved = true;
        $('#p2-paper').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot2').exists()) {
            moveRef.update({'slot2': 'Paper'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot1').exists()) {
                outputMessage('You chose Paper.');
            } else {
                outputMessage("You chose Paper... waiting for opponent's move");
            }
        }
    });
});
$('#p1-scissors').click(function(event) {
    if (!p1_moved) {
        p1_moved = true;
        $('#p1-scissors').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot1').exists()) {
            moveRef.update({'slot1': 'Scissors'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot2').exists()) {
                outputMessage('You chose Scissors.');
            } else {
                outputMessage("You chose Scissors... waiting for opponent's move");
            }
        }
    });
});
$('#p2-scissors').click(function(event) {
    if (!p2_moved) {
        p2_moved = true;
        $('#p2-scissors').addClass('active');
    }
    moveRef.once('value').then(function(ss) {
        if (!ss.child('slot2').exists()) {
            moveRef.update({'slot2': 'Scissors'});
            moveRef.onDisconnect().remove();
            if (ss.child('slot1').exists()) {
                outputMessage('You chose Scissors.');
            } else {
                outputMessage("You chose Scissors... waiting for opponent's move");
            }
        }
    });
});

$('#send-btn').click(function(event) {
    var msg = $('#chat-msg').val();
    $('#chat-msg').val('');
    if (msg !== "") {
        msgRef.push({ 'from': uname, 'msg': msg });
    }
    msgRef.onDisconnect().remove();
});
// wait for the entire document to load before running the init() functionj
$(document).ready(function() {
		init();
});
